/**
 * random-dungeon-generator - v0.0.1
 * Copyright (c) 2014, Jorge Perez (http://www.jorgeprodriguez.me)
 * Compiled: 2014-03-12
 * random-dungeon-generator is licensed under the MIT License (http://www.opensource.org/licenses/mit-license.php)
 */
function RNG(a){this.m=2147483648,this.a=1103515245,this.c=12345,this.state=a?a:Math.floor(Math.random()*(this.m-1))}function Cartography(){}function AStar(a,b){function c(a){o.push(a),o.sort(AStar.sort)}function d(a){p.push(a)}function e(a){for(var b=0,c=o.length;c>b;b++)if(o[b]===a)return o.splice(b,1);return!1}function f(a){for(var b=0,c=o.length;c>b;b++){var d=o[b];if(d.x===a.x&&d.y===a.y)return d}return!1}function g(a){for(var b=0,c=p.length;c>b;b++){var d=p[b];if(d.x===a.x&&d.y===a.y)return d}return!1}function h(a){for(var b=[],c=0;4>c;c++){var d=Cartography.direction(c);try{for(var e=1;q>=e;e++){var f=k[a.x+e*d.dx][a.y+e*d.dy];if(!r.stepCondition(f.x,f.y))break;e===q&&b.push({x:f.x,y:f.y,parent:a,dir:d,g:a.g+AStar.manhattan(a,f),h:AStar.manhattan(f,m),f:a.g+AStar.manhattan(a,f)+AStar.manhattan(f,m)})}}catch(g){continue}}return b}function i(a){return r.goalCondition(a.x,a.y,m.x,m.y)}function j(){if(0===o.length)return!1;if(n=o[0],i(n))return!0;e(n),d(n);for(var a=h(n),b=0,k=a.length;k>b;b++){var l=a[b],m=g(l);if(!(m&&l.g>m.g)){var p=f(l);(!p||l.g<p.g)&&(p?p=l:c(l))}}return j()}var k,l,m,n,o,p,q;this.searchPath=function(a,b,d,e){return k=a,q=e,l={x:b.x,y:b.y,parent:null,dir:null,g:0,h:AStar.manhattan(b,d),f:AStar.manhattan(b,d)},m={x:d.x,y:d.y,parent:null,dir:null,g:0,h:0,f:0},o=[],p=[],c(l),j()},this.buildPath=function(){var a=[],b=n;for(a.push(b);b.parent;)a.push(b.parent),b=b.parent;return a},this.stepCondition=a,this.goalCondition=b;var r=this}function Cell(a,b,c){this.x=a,this.y=b,this.type=c,this.room=null,this.connected=!1}function Stairs(a,b,c){this.x=a,this.y=b,this.up=c}function Door(a,b,c,d){this.x=a,this.y=b,this.orientation=c,this.interior=d}function Room(a,b,c,d,e){this.id=a,this.inix=b,this.iniy=c,this.width=d,this.height=e,this.doors=[]}function Floor(a,b,c){function d(a){switch(a){default:for(var b=0;b<K.width;b++)for(var c=0;c<K.height;c++)K.layout[b][c]=0===b||b===K.layout.length-1||0===c||c===K.layout[b].length-1?new Cell(b,c,Cell.BLOCKED):new Cell(b,c,Cell.EMPTY)}}function e(){var a=E,b=D,c=A(Math.round(Math.max(K.width-2,K.height-2)/a));b>c&&(c=b),f(b,c),h(b,c),j(),m(),p()}function f(a,b){for(var c=3,d=K.layout.length-a,e=3,f=K.layout[0].length-a,h=Math.round((K.width-2)*(K.height-2)/Math.pow(b,2));0===K.rooms.length;)for(var i=0;h>i;i++){var j=A(F.nextRange(c,d+1)),k=A(F.nextRange(e,f+1)),l=A(F.nextRange(a,b+1)),m=A(F.nextRange(a,b+1));if(a>l&&(l=a),a>m&&(m=a),j+l>d&&(l=d-j),k+m>f&&(m=f-k),!(a>l||a>m)&&w(j,k,l,m)){var n=new Room(K.rooms.length,j,k,l,m);g(n),K.rooms.push(n)}}}function g(a){for(var b=a.inix-1,c=a.inix+a.width+1;c>b;b++)for(var d=a.iniy-1,e=a.iniy+a.height+1;e>d;d++)b===a.inix-1||b===a.inix+a.width||d===a.iniy-1||d===a.iniy+a.height?K.layout[b][d].type!==Cell.BLOCKED&&(K.layout[b][d].type=Cell.PERIMETER):(K.layout[b][d].type=Cell.ROOM,K.layout[b][d].room=a)}function h(a){for(var b=0,c=K.rooms.length;c>b;b++){var d=K.rooms[b],e=Math.round(d.width*d.height/Math.pow(a,2)),f=F.nextRange(1,e);i(d,f)}}function i(a,b){for(;b>0;){var c,d,e,f,g,h,i,j,k=F.nextRange(0,4);switch(k){case Cartography.NORTH:c=A(F.nextRange(a.inix,a.inix+a.width-1)),d=a.iniy-1,e=c,f=d-1,g=c-1,h=d,i=c+1,j=d;break;case Cartography.EAST:c=a.inix+a.width,d=A(F.nextRange(a.iniy,a.iniy+a.height-1)),e=c+1,f=d,g=c,h=d-1,i=c,j=d+1;break;case Cartography.SOUTH:c=A(F.nextRange(a.inix,a.inix+a.width-1)),d=a.iniy+a.height,e=c,f=d+1,g=c-1,h=d,i=c+1,j=d;break;case Cartography.WEST:c=a.inix-1,d=A(F.nextRange(a.iniy,a.iniy+a.height-1)),e=c-1,f=d,g=c,h=d-1,i=c,j=d+1}if(K.layout[c][d].type===Cell.PERIMETER&&K.layout[e][f].type!==Cell.BLOCKED&&K.layout[g][h].type===Cell.PERIMETER&&K.layout[i][j].type===Cell.PERIMETER){var l=!1;K.layout[e][f].type!==Cell.ROOM?b--:l=!0,a.doors.push(new Door(c,d,k,l)),K.layout[c][d].type=Cell.DOOR}}}function j(){for(;!u();){var a=K.rooms[F.nextRange(0,K.rooms.length)];k(a)}}function k(a){if(!K.layout[a.inix][a.iniy].connected){for(var b=a.inix,c=a.inix+a.width;c>b;b++)for(var d=a.iniy,e=a.iniy+a.height;e>d;d++)K.layout[b][d].connected=!0;for(var f=0,g=a.doors.length;g>f;f++){var h=a.doors[f],i=Cartography.direction(h.orientation);if(K.layout[h.x][h.y].connected=!0,h.interior){var j=K.layout[h.x+i.dx][h.y+i.dy].room;K.layout[j.inix][j.iniy].connected||k(j)}else if(K.rooms.length<=1){var m=o();K.layout[m.x][m.y].connected=l(h,m,i)}else{var j=v();if(!j)for(var n=!0;n;)j=K.rooms[F.nextRange(0,K.rooms.length)],n=j===a;for(var p=j.doors[F.nextRange(0,j.doors.length)];p.interior;)p=j.doors[F.nextRange(0,j.doors.length)];l(h,p,i)&&(K.layout[p.x][p.y].connected=!0,k(j))}}}}function l(a,b,c){a=K.layout[a.x+c.dx][a.y+c.dy],a.type===Cell.EMPTY&&(a.type=Cell.CORRIDOR,a.connected=!0);var d=J.searchPath(K.layout,a,b,2);return z(J.buildPath()),d}function m(){for(var a=F.nextRange(0,K.rooms.length),b=0;a>b;b++){var c=n(),d=o();if(!c||!d)return;J.searchPath(K.layout,c,d,2)&&(z(J.buildPath()),K.layout[d.x][d.y].type=Cell.DEADEND,K.layout[d.x][d.y].connected=!0,K.deadEnds.push(d))}}function n(){for(var a=A(F.nextRange(0,K.width)),b=A(F.nextRange(0,K.height)),c=0;c<K.width;c+=2)for(var d=0;d<K.height;d+=2){var e=(a+c)%(K.width-1),f=(b+d)%(K.height-1);if(K.layout[e][f].type===Cell.CORRIDOR&&K.layout[e][f].connected)return K.layout[e][f]}return!1}function o(){for(var a=A(F.nextRange(0,K.width)),b=A(F.nextRange(0,K.height)),c=0;c<K.width;c+=2)for(var d=0;d<K.height;d+=2){var e=(a+c)%(K.width-1),f=(b+d)%(K.height-1);if(K.layout[e][f].type===Cell.EMPTY&&t(e,f))return K.layout[e][f]}return!1}function p(){q(!1),q(!0)}function q(a){for(var b=!1;!b;){var c=F.nextRange(0,K.deadEnds.length+K.rooms.length);c<K.deadEnds.length?b=r(K.deadEnds[c],a):(c-=K.deadEnds.length,b=s(K.rooms[c],a))}}function r(a,b){if(a.type===Cell.STAIRS)return!1;a.type=Cell.STAIRS;var c=new Stairs(a.x,a.y,b);return K.stairs.push(c),!0}function s(a,b){if(x(a))return!1;var c=F.nextRange(0,a.width*a.height),d=a.inix+c%a.width,e=a.iniy+Math.floor(c/a.width),f=K.layout[d][e];if(f.type===Cell.STAIRS)return!1;for(var g=0;4>g;g++){var h=Cartography.direction(g),i=K.layout[d+h.dx][e+h.dy];if(i.type===Cell.DOOR)return!1}f.type=Cell.STAIRS;var j=new Stairs(d,e,b);return K.stairs.push(j),!0}function t(a,b){for(var c=0;4>c;c++){var d=Cartography.direction(c),e=K.layout[a+d.dx][b+d.dy];if(e.type!==Cell.EMPTY&&e.type!==Cell.BLOCKED)return!1}return!0}function u(){for(var a=0,b=K.rooms.length;b>a;a++){var c=K.rooms[a];if(!K.layout[c.inix][c.iniy].connected)return!1}return!0}function v(){for(var a=0,b=K.rooms.length;b>a;a++){var c=K.rooms[a];if(!K.layout[c.inix][c.iniy].connected)return c}return!1}function w(a,b,c,d){for(var e=a,f=a+c;f>e;e++)for(var g=b,h=b+d;h>g;g++)if(K.layout[e][g].type!=Cell.EMPTY)return!1;return!0}function x(a){for(var b=a.inix,c=a.inix+a.width;c>b;b++)for(var d=a.iniy,e=a.iniy+a.height;e>d;d++){var f=K.layout[b][d];if(f.type===Cell.STAIRS)return!0}return!1}function y(a,b,c){var d=K.layout[a+c.dx][b+c.dy],e=K.layout[a+2*c.dx][b+2*c.dy];if(d.connected||(d.type=Cell.CORRIDOR,d.connected=!0),e.connected){if(e.type===Cell.DEADEND){for(var f=0,g=K.deadEnds.length;g>f;f++){var h=K.deadEnds[f];if(h.x===e.x&&h.y===e.y){K.deadEnds.splice(f,1);break}}e.type=Cell.CORRIDOR}}else e.type=Cell.CORRIDOR,e.connected=!0}function z(a){for(var b=a.length-1;b>0;b--){var c=a[b],d=a[b-1].dir;y(c.x,c.y,d)}}function A(a){return Math.abs(a%2===0?a-1:a)}var B=9,C=9,D=3,E=4,F=new RNG(Date.now());this.width=B>a?B:A(a),this.height=C>b?C:A(b),this.type=c,this.rooms=[],this.deadEnds=[],this.stairs=[],this.layout=new Array(this.width);for(var G=0;G<this.width;G++)this.layout[G]=new Array(this.height);var H=function(a,b){var c=K.layout[a][b].type;return c===Cell.EMPTY||c===Cell.CORRIDOR||c===Cell.DOOR||c===Cell.DEADEND},I=function(a,b,c,d){if(c===a&&d===b)return!0;for(var e=0;4>e;e++){var f=Cartography.direction(e);if(c===a+f.dx&&d===b+f.dy)return!0}return!1},J=new AStar(H,I),K=this;d(c),e()}function Dungeon(){this.floors=[],this.addFloor=function(a,b,c){this.floors.push(new Floor(a,b,c))},this.addMultipleFloors=function(a,b,c,d){for(var e=0;a>e;e++)this.addFloor(b,c,d)},this.draw=function(e,f,g){var h=this.floors[e],i=20;f.width=i*h.width,f.height=i*h.height;for(var j=f.getContext("2d"),k=0;k<h.width;k++)for(var l=0;l<h.height;l++){switch(h.layout[k][l].type){case Cell.BLOCKED:j.fillStyle=a;break;case Cell.EMPTY:j.fillStyle=a;break;case Cell.ROOM:j.fillStyle=b;break;case Cell.PERIMETER:j.fillStyle=a;break;case Cell.DOOR:j.fillStyle=c;break;case Cell.CORRIDOR:j.fillStyle=b;break;case Cell.DEADEND:j.fillStyle=b;break;case Cell.STAIRS:j.fillStyle=d}j.fillRect(i*k,i*l,i,i),g&&(j.rect(i*k,i*l,i,i),j.stroke())}};var a="#344A5F",b="#F0F1F2",c="#F3AE4E",d="#CF5C60"}RNG.prototype.nextInt=function(){return this.state=(this.a*this.state+this.c)%this.m,this.state},RNG.prototype.nextFloat=function(){return this.nextInt()/(this.m-1)},RNG.prototype.nextRange=function(a,b){var c=b-a,d=this.nextInt()/this.m;return a+Math.floor(d*c)},RNG.prototype.choice=function(a){return a[this.nextRange(0,a.length)]},Cartography.NORTH=0,Cartography.EAST=1,Cartography.SOUTH=2,Cartography.WEST=3,Cartography.direction=function(a){switch(a){case Cartography.NORTH:return{dx:0,dy:-1};case Cartography.EAST:return{dx:1,dy:0};case Cartography.SOUTH:return{dx:0,dy:1};case Cartography.WEST:return{dx:-1,dy:0};default:return{dx:0,dy:0}}},AStar.sort=function(a,b){return a.f>b.f?1:a.f<b.f?-1:0},AStar.manhattan=function(a,b){return Math.abs(a.x-b.x)+Math.abs(a.y-b.y)},Cell.BLOCKED=0,Cell.EMPTY=1,Cell.ROOM=2,Cell.PERIMETER=3,Cell.DOOR=4,Cell.CORRIDOR=5,Cell.DEADEND=6,Cell.STAIRS=7;